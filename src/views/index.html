<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrega de OFs</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- DateRange Picker -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
</head>
<body>
    <div class="container-fluid p-5">
        <div class="card m-5">
            <div class="card-body card-loading flex justify-content-center">
                Carregando...
            </div>
            <div class="card-body card-setting-git flex p-5 flex-column none">
                <h1>Configuração GIT</h1>
                <legend>Você ainda não configurou seu git, utilize os campos abaixo para configurar o Git.</legend>

                <form>
                    <div class="mb-3">
                        <label for="gitUrl" class="form-label">Url da API do seu GIT</label>
                        <input type="text" class="form-control" id="gitUrl" placeholder="https://gitlab.com.br/api/v4">
                    </div>
                    <div class="mb-3">
                        <label for="accessToken" class="form-label">Access Token</label>
                        <input type="text" class="form-control" id="accessToken">
                    </div>
                    <div class="d-flex">
                        <button type="button" id="btn-test-connection" class="btn btn-primary me-4">Testar Conexão</button>
                        <button type="button" id="btn-salvar-dados-git" class="btn btn-primary" disabled>Salvar</button>
                    </div>
                </form>
            </div>
            <div class="card-body p-5 flex-column none card-tasks">
                <h1>Adição de tarefas</h1>
                <form id="form-add-task" class="row">
                    <div class="mb-3 col-2">
                        <label for="task-id" class="form-label">Número da tarefa*</label>
                        <input type="text" class="form-control" id="task-id">
                    </div>
                    <div class="mb-3 col-3">
                        <label for="task-period" class="form-label">Períoro da tarefa*</label>
                        <input type="text" class="form-control" id="task-period" value="01/01/2024 - 01/15/2024">
                    </div>
                    <div class="mb-3 col-3">
                        <label for="task-project" class="form-label">Nome do Projeto</label>
                        <input type="text" class="form-control" id="task-project">
                    </div>
                    <div class="mb-3 col-4">
                        <label for="task-branch" class="form-label">Nome da Branch</label>
                        <input type="text" class="form-control" id="task-branch">
                    </div>
                    <div class="mt-4 pt-2 col-2">
                        <button type="button" id="btn-add-task" class="btn btn-primary">Adicionar</button>
                    </div>
                </form>

                <table class="table">
                    <thead>
                      <tr>
                        <th scope="col">Num. Tarefa</th>
                        <th scope="col">Períoro</th>
                        <th scope="col">Projeto</th>
                        <th scope="col">Branch</th>
                        <th scope="col">Ação</th>
                      </tr>
                    </thead>
                    <tbody id="table-task">
                    </tbody>
                </table>

                <div class="row justify-content-end mt-5">
                    <div class="col-2">
                        <button type="button" id="btn-save-task" class="btn btn-primary px-5">Salvar</button>
                    </div>
                </div>
            </div>
            <div class="card-body card-user none">
                <h1>Relatórios</h1>
                <div>
                    <ul>
                        <li>Status: <span id="user-status">Atualizado.</span></li>
                        <li>Status do Git: <span>Configurado</span></li>
                        <li>Status do usuário: <span id="user-data-status">Dados ainda não carregados</span></li>
                        <li>Commits esse mês: <span id="user-git-commits">0</span></li>
                    </ul>

                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                          <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                              Relatório
                            </button>
                          </h2>
                          <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                              <div id="user-report" class="accordion"></div>
                            </div>
                          </div>
                        </div>
                      </div>

                    <button type="button" id="btn-atualizar-dados-git" class="btn btn-primary">Atualizar Dados do Git</button>
                </div>
            </div>
        </div>
    </div>    
</body>
<script>
    $(() => {
        axios.get('/git-info')
        .then((res) => {
            $(".card-loading").hide();
            $(".card-setting-git").hide();
            $(".card-tasks").hide();
            $(".card-user").hide();
            if (!res.data.git.accessToken || !res.data.git.gitUrl) {
                return $(".card-setting-git").show();
            }
            
            if (!res.data.task || !res.data.task.length) return $(".card-tasks").show();

            $("#accessToken").val(res.data.accessToken);
            $("#gitUrl").val(res.data.gitUrl);
            $(".card-user").show();
            getUserDataOnGit();
        });

        // add task

        $('#task-period').daterangepicker();
        const allTasksAdd = [];
        $("#btn-add-task").on("click", () => {
            const taskId = $("#task-id").val();
            const taskProject = $("#task-project").val();
            const taskPeriod = $("#task-period").val();
            const taskBranch = $("#task-branch").val();

            if (!taskId || !taskPeriod) return alert("Número da tarefa e o período são obrigatórios!");

            allTasksAdd.push({
                id: taskId,
                period: taskPeriod,
                project: taskProject ?? null,
                branch: taskBranch ?? null
            });

            renderTableTasks();
        });
        $("#btn-save-task").on('click', () => {
            axios.post('/tasks', { tasks: allTasksAdd })
            .then(() => {
                $(".card-setting-git").hide();
                $(".card-tasks").hide();
                $(".card-user").show();
            })
            .catch((res) => alert(res?.response?.data?.message ?? "Falha ao salvar as tasks!"))
        });

        function renderTableTasks() {
            $("#table-task").html('');
            allTasksAdd.forEach(({id, period, project, branch}, index) => {
                $("#table-task").append(`<tr>
                    <td>${id}</td>
                    <td>${period}</td>
                    <td>${project ?? ''}</td>
                    <td>${branch ?? ''}</td>
                    <td><button class="btn btn-danger btn-remove-task" data-index="${index}">Remover</button></td>
                </tr>`);
            });
            addButtonsListners();
        }
        function addButtonsListners() {
            $(".btn-remove-task").off();
            $(".btn-remove-task").on("click", function() {
                const index = $(this).attr("data-index");
                console.log(index)
                if (index !== undefined && index !== null && index !== '') {
                    allTasksAdd.splice(index, 1);
                    renderTableTasks();
                }
            });
        }

        $("#btn-test-connection").on("click", () => {
            const accessToken = $("#accessToken").val();
            const gitUrl = $("#gitUrl").val();

            if (!accessToken || !gitUrl) {
                return alert("Você precisa preencher os campos corretamente para poder salvar os dados!");
            }

            axios.get(`/git-connection?accessToken=${accessToken}&gitUrl=${gitUrl}`)
            .then((res) => {
                if (res.data.status === 200) {
                    alert("Conexão efetuada com sucesso!");
                    return $("#btn-salvar-dados-git").prop("disabled", false);
                }
                
                alert("Falha na conexão com o Git");
            })
            .catch(() => alert("Falha na conexão com o Git"));
        });

        $("#btn-salvar-dados-git").on("click", () => {
            const accessToken = $("#accessToken").val();
            const gitUrl = $("#gitUrl").val();

            if (!accessToken || !gitUrl) {
                return alert("Você precisa preencher os campos corretamente para poder salvar os dados!")
            }

            $("#btn-salvar-dados-git").prop("disabled", true);

            axios.post('/git-info', {
                accessToken,
                gitUrl
            }).then((res) => {
                $(".card-setting-git").hide();
                $(".card-user").hide();
                $(".card-tasks").show();
            }).catch((error) => {
                alert(error?.response?.data?.message ?? "Erro ao realizar requisição.");
            })
            .then(() => {
                $("#btn-salvar-dados-git").prop("disabled", false);
            })
        });

        $("#btn-atualizar-dados-git").on("click", () => {
            const originalText = $("#btn-atualizar-dados-git").text();
            $("#btn-atualizar-dados-git").prop("disabled", true).text("carregando dados...");

            axios.post('/git-update')
            .then(() => getUserDataOnGit())
            .catch(() => {
                alert("Falha ao atualizar dados do GIT, favor verificar os dados de configuração do GIT!");
                $(".card-setting-git").show();
                $(".card-user").hide();
            })
            .then(() => $("#btn-atualizar-dados-git").prop("disabled", false).text(originalText));
        });

        const getUserDataOnGit = async () => {
            $("#user-status").text("Atualizando dados, aguarde...");
            const dataByCategories = await axios.get('/git-data-category')
            .catch((err) => console.error(err));
            const commits = await axios.get('/git-commits')
            .catch((err) => console.error(err));
            
            if (dataByCategories) {
                $('#user-data-status').text("Dados Sincronizados");
                $("#user-git-commits").text(commits.data.commits);
                const divReport = $("#user-report")
                dataByCategories.data.forEach((category, index) => {
                    divReport.append(`
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#report-category-${index}" aria-expanded="false" aria-controls="report-category-${index}">
                                ${category.categoria}
                                </button>
                            </h2>
                            <div id="report-category-${index}" class="accordion-collapse collapse" data-bs-parent="#user-report">
                                <div class="accordion-body">
                                    <div class="mb-3 col-8">
                                        <textarea type="text" class="form-control" id="categoria-${index}">${category.arquivos.join('\n')}</textarea>
                                        <button type="button" data-index="${index}" class="btn btn-primary btn-copiar">Copiar</button>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    `);
                })
            }
            $("#user-status").text("Atualizado.");
            $(".btn-copiar").on('click', function () {
                const button = $(this);
                const categoria = button.data('index');
                const textarea = $(`#categoria-${categoria}`);
                console.log(categoria, textarea, textarea.val())
                textarea.select();
                navigator.clipboard.writeText(textarea.val());
                button.text('Copiado!');
                button.prop('disabled', true);
            });
        }

    });
</script>
<style>
    .card {
        min-width: 50vw;
        min-height: 70vh;
    }
    .card-body {
        align-items: center;
    }
    .card-body form {
        width: 100%;
        padding: 16px;
    }
    .none {
        display: none;
    }
    .flex {
        display: flex;
    }
</style>
</html>